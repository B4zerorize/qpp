<html>
<body>
<h1>Feature Test DevtoolsPage</h1>
</body>
<script src="chrome-extension://klmlfkibgfifmkanocmdenpieghpgifl/ChannelPlate/ChannelPlate.js"></script>
<script src="chrome-extension://klmlfkibgfifmkanocmdenpieghpgifl/ChannelPlate/RemoteMethodCall.js"></script>
<script src="chrome-extension://klmlfkibgfifmkanocmdenpieghpgifl/AsyncMachine.js"></script>
<script src="../../../DebugLogger.js"></script>
<script src="../PatientSelector.js"></script>
<script src="../devtools-page-test.js"></script>
<script src="../panel-test.js"></script>
<script>

window.addEventListener('load', function() {
  testScript();
});

function testScript() {
  console.log("------------test begins------------");
  AsyncMachine.pushOp(ExtensionTestAPI.evaluateInPage, 'window.location="http://localhost:8686/test/qpd.html"');
  AsyncMachine.pushOp(DevtoolsWindowTestAPI.openPanel, 'Console');
  AsyncMachine.pushOp(DevtoolsWindowTestAPI.whenSelectorAll, 'button.toggled-on', 'Console');
  AsyncMachine.pushOp(ExtensionTestAPI.evaluateInPage, 'console.log(window.location.href)');
  AsyncMachine.pushOp(DevtoolsWindowTestAPI.whenSelectorAll, 'span', 'This is your first warning');

  function report() {
    var results = DevtoolsExtended.testResults;
    delete DevtoolsExtended.testResults;
    return results ? results.join('\n') : "no content in testResults";
  }
  function setup() {
    try {
      function notifyViaConsole(sentinal) {
        // Put something in the console to ensure order of execution
        chrome.devtools.inspectedWindow.eval('console.log(\"' + sentinal + '\"), 16', function(result, isException) {
            if (result !== 16)
              console.error("notifyViaConsole FAILED " + result, isException);
        });
      }
      var InspectedWindow = DevtoolsExtended.InspectedWindow;
      DevtoolsExtended.testListener = function(url) {
        DevtoolsExtended.testResults = DevtoolsExtended.testResults  || [];
        DevtoolsExtended.testResults.push("testListener fired for " + url);
        notifyViaConsole('onURLChanged '+ arguments[0]);
      };
      InspectedWindow.onURLChanged.addListener(DevtoolsExtended.testListener);

      notifyViaConsole('setupComplete');
      return "Listening for onURLChanged, reloaded."
    } catch (e) {
      console.error("setup fails ", e, e.stack);
      return 'setup fails ' + e + ' stack: ' + e.stack;
    }
  }
  AsyncMachine.pushOp(ExtensionTestAPI.evaluate, "(" + setup +"());");
  AsyncMachine.pushOp(DevtoolsWindowTestAPI.whenSelectorAll, 'span', 'setupComplete');
  AsyncMachine.pushOp(ExtensionTestAPI.evaluate, "(" + report + "());", function(text) {
    return "check testListener: " + text;
  });
  // Change the viewed page
  AsyncMachine.pushOp(ExtensionTestAPI.evaluateInPage, 'window.location="http://localhost:8686/test/switch.html"');
  AsyncMachine.pushOp(DevtoolsWindowTestAPI.whenSelectorAll, 'span', 'onURLChanged');
  AsyncMachine.pushOp(ExtensionTestAPI.evaluate, "(" + report + "());", function(text) {
    return "check testListener: " + text;
  });

  function verifyReload() {
    DevtoolsExtended.InspectedWindow.reload();
  }
  AsyncMachine.pushOp(ExtensionTestAPI.evaluate, "(" + verifyReload +"());");
  AsyncMachine.pushOp(ExtensionTestAPI.evaluate, "(" + report + "());", function(text) {
    return "check no content: " + text;
  });
  function tearDown() {
    DevtoolsExtended.InspectedWindow.onURLChanged.removeListener(DevtoolsExtended.testListener);
    return "Listener removed";
  }
  AsyncMachine.pushOp(ExtensionTestAPI.evaluate, "(" + tearDown +"());");
  AsyncMachine.pushOp(ExtensionTestAPI.evaluateInPage, 'window.location="http://localhost:8686/test/qpd.html"');
  AsyncMachine.pushOp(ExtensionTestAPI.evaluate, "(" + report + "());", function(text) {
    return "check no content: " + text;
  });

  function testProcessing() {
      function notifyViaConsole(sentinal) {
        // Put something in the console to ensure order of execution
        chrome.devtools.inspectedWindow.eval('console.log(\"' + sentinal + '\"), 16', function(result, isException) {
            if (result !== 16)
              console.error("notifyViaConsole FAILED " + result, isException);
        });
      }
    var InspectedWindow = DevtoolsExtended.InspectedWindow;
    DevtoolsExtended.testListener = function(runtimeInstalled) {
      DevtoolsExtended.testResults = DevtoolsExtended.testResults  || [];
      DevtoolsExtended.testResults.push("testListener sees runtimeInstalled " + runtimeInstalled);
      notifyViaConsole('runtimeInstalled '+ arguments[0]);
    };
    InspectedWindow.onRuntimeChanged.addListener(DevtoolsExtended.testListener);

    function injectedScript() {
      window.iAmInjected = true;
    }
    function preprocessingScript(src, url, fnc) {
      var prefix = 'window.wasPreprocessed = window.wasPreprocessed || [];\n' +
        'window.wasPreprocessed.push(\"' + url + '\");\n';
      return prefix + src + '\n//# sourceURL=' + url + '.js';
    }
    InspectedWindow.injectedScript = '(' + injectedScript + ')()';
    InspectedWindow.preprocessingScript = '(' + preprocessingScript + ')';
    notifyViaConsole('sentPreprocessing')
  }
  AsyncMachine.pushOp(ExtensionTestAPI.evaluate, "(" + testProcessing +"());");
  AsyncMachine.pushOp(DevtoolsWindowTestAPI.whenSelectorAll, 'span', 'sentPreprocessing');

  AsyncMachine.pushOp(ExtensionTestAPI.evaluate, "(" + verifyReload +"());");
    AsyncMachine.pushOp(DevtoolsWindowTestAPI.whenSelectorAll, 'span', 'runtimeInstalled');
  AsyncMachine.pushOp(ExtensionTestAPI.evaluate, "(" + report + "());", function(text) {
    return "check runtime changed: " + text;
  });
  AsyncMachine.pushOp(ExtensionTestAPI.evaluateInPage, 'window.location.href');
  AsyncMachine.pushOp(ExtensionTestAPI.evaluateInPage, 'window.wasPreprocessed.join(",") + "," + window.iAmInjected');

  AsyncMachine.runOp();
}

</script>
</html>
