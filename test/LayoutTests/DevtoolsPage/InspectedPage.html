<html>
<body>
<h1>Feature Test DevtoolsPage</h1>
</body>
<script src="chrome-extension://klmlfkibgfifmkanocmdenpieghpgifl/ChannelPlate/ChannelPlate.js"></script>
<script src="chrome-extension://klmlfkibgfifmkanocmdenpieghpgifl/ChannelPlate/RemoteMethodCall.js"></script>
<script src="chrome-extension://klmlfkibgfifmkanocmdenpieghpgifl/AsyncMachine.js"></script>
<script src="../../../DebugLogger.js"></script>
<script src="../PatientSelector.js"></script>
<script src="../devtools-page-test.js"></script>

<script>

window.addEventListener('load', function() {
  testScript();
});

function testScript() {
  console.log("------------test begins------------");
  AsyncMachine.pushOp(ExtensionTestAPI.evaluateInPage, 'window.location="http://localhost:8686/test/qpd.html"');

  function setup() {
    try {
      Querypoint.testResults = [];
      var InspectedPage = Querypoint.InspectedPage;
      Querypoint.testListener = function() {
        Querypoint.testResults.push('onURLChanged ' + arguments[0]);
      };
      InspectedPage.onURLChanged.addListener(Querypoint.testListener);
      InspectedPage.monitorNavigation();
      InspectedPage.reload();
    } catch (e) {
      Querypoint.testResults.push('setup fails ' + e + ' stack: ' + e.stack);
    }
  }
  AsyncMachine.pushOp(ExtensionTestAPI.evaluate, "(" + setup +"());");
  // Change the viewed page
  AsyncMachine.pushOp(ExtensionTestAPI.evaluateInPage, 'window.location="http://localhost:8686/test/switch.html"');
  function tearDown() {
    Querypoint.InspectedPage.onURLChanged.removeListener(Querypoint.testListener);
    Querypoint.testResults.push("Listener removed");
  }
  AsyncMachine.pushOp(ExtensionTestAPI.evaluate, "(" + tearDown +"());");
  AsyncMachine.pushOp(ExtensionTestAPI.evaluateInPage, 'window.location="http://localhost:8686/test/qpd.html"');
  function report() {
    return Querypoint.testResults.join('\n');
  }
  AsyncMachine.pushOp(ExtensionTestAPI.evaluate, "(" + report + "());");

  AsyncMachine.runOp();
}

</script>
</html>
