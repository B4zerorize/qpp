<html>
<body>
<h1>Feature Test lastChange</h1>
</body>
<script src="chrome-extension://klmlfkibgfifmkanocmdenpieghpgifl/ChannelPlate/ChannelPlate.js"></script>
<script src="chrome-extension://klmlfkibgfifmkanocmdenpieghpgifl/ChannelPlate/RemoteMethodCall.js"></script>
<script src="chrome-extension://klmlfkibgfifmkanocmdenpieghpgifl/PatientSelector.js"></script>

<script>
//-------------------------------------------------------------------------------------------------------
var SignalTokens = {
    COMPLETE: "InspectorTest.testComplete: ",
    RESULT: "InspectorTest.addResult: ",
    CLEAR: "InspectorTest.clearResults: ",
    PATIENT_SELECTOR: "PatientSelectorAPI",
    DEVTOOLS_WINDOW: "DevtoolsWindowTestAPI",
    EXTENSION_WINDOW: "ExtensionWindowTestAPI",
    DEVTOOLS_PATH: 'inspector/front-end/devtools.html'
};

//---------------------------------------------------------------------------------------------------------
var testRunner = {
  callId: 0,
  _send: function(method, args) {
    window.parent.postMessage([method].concat(args), '*');
  },
  evaluateForTest: function(script) {
    this._send('evaluateForTest', [this.callId++, script]);
  },
};
window.addEventListener('load', function() {
  //testRunner.evaluateForTest('(' + testScript + ')()');
  testScript();
});


// The test case iframe is a child of the extension iframe
var ExtensionWindowTestAPI = (new RemoteMethodCall.Requestor(PatientSelector, ChannelPlate.ChildIframe)).serverProxy();
        

// The extension iframe is a child of devtools, so the test case iframe is a grandchild
function GrandChildIframe(onMessage) {
  ChannelPlate.Talker.call(this, window.parent.parent, onMessage);
}

GrandChildIframe.prototype = Object.create(ChannelPlate.Talker.prototype);


var DevtoolsWindowTestAPI = (new RemoteMethodCall.Requestor(PatientSelector, GrandChildIframe)).serverProxy();
//-----------------------------------------------------------------------------

console.log("begin " + window.location);

function openQuerypointPanel(then) {
  DevtoolsWindowTestAPI.clickSelector('div.toolbar-label', 'Querypoint', then);
}

function openSourceFile(fileName, then) {
  DevtoolsWindowTestAPI.clickSelector('div.item', fileName, then);
}

function searchSource(tokens, then) {
  return then();
  ExtensionWindowTestAPI.searchSource(tokens, then)
}

function runQuery(name, then) {
  console.log("runQuery " + name);
  ExtensionWindowTestAPI.clickSelector('span.cm-property', 'prop');
}

var AsyncMachine = {
  ops: [],
  pushOp: function(fnc, opt_args) {
    var args = Array.prototype.slice.apply(arguments);
    args.shift();
    args.push(this.runOp.bind(this));
    this.ops.push({fnc: fnc, args: args});
  },
  runOp: function() {
    var op = this.ops.shift();
    if (op) {
      console.log("Running test operation ", op);
      op.fnc.apply(this, op.args);
    } else {
      console.log("Test Operations Completed")
    }
  }

};

function test_lastChange() {
  console.log("test_lastChange begins, using DevtoolsWindowTestAPI:", DevtoolsWindowTestAPI);
  AsyncMachine.pushOp(openQuerypointPanel);
  AsyncMachine.pushOp(openSourceFile, 'demo.js');
  AsyncMachine.pushOp(searchSource, ['updateButton', 'obj.prop', 'prop']); 
  AsyncMachine.pushOp(runQuery, 'lastChange');

  AsyncMachine.runOp();
}

var testScript = test_lastChange;
</script>
</html>